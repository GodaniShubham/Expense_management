{% extends 'base.html' %}

{% block title %}Create Approval Rule - Expense Management{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <div class="bg-white rounded-xl shadow-lg p-8">
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">‚öôÔ∏è Create Approval Rule</h1>
            <p class="text-gray-600">Define how expenses should be approved in your organization.</p>
        </div>

        <form method="POST" id="ruleForm" class="space-y-6">
            {% csrf_token %}
            
            <div class="space-y-2">
                <label for="name" class="block text-sm font-medium text-gray-700">
                    üìù Rule Name <span class="text-red-500">*</span>
                </label>
                <input type="text" name="name" id="name" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                    placeholder="e.g., Standard Approval Flow">
            </div>

            <div class="space-y-2">
                <label for="rule_type" class="block text-sm font-medium text-gray-700">
                    üéØ Rule Type <span class="text-red-500">*</span>
                </label>
                <select name="rule_type" id="rule_type" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                    <option value="">Select a rule type</option>
                    <option value="percentage">Percentage-based (requires X% approval)</option>
                    <option value="specific">Specific Approver (requires one person)</option>
                    <option value="hybrid">Hybrid (specific approver OR percentage)</option>
                    <option value="sequential">Sequential (all approvers in order)</option>
                </select>
                <p class="text-xs text-gray-500">Choose how approvals should be processed</p>
            </div>

            <div id="percentageField" class="space-y-2" style="display: none;">
                <label for="percentage_threshold" class="block text-sm font-medium text-gray-700">
                    üìä Approval Percentage Threshold
                </label>
                <div class="flex items-center space-x-2">
                    <input type="number" name="percentage_threshold" id="percentage_threshold" 
                        min="1" max="100" step="1"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                        placeholder="e.g., 50">
                    <span class="text-2xl">%</span>
                </div>
                <p class="text-xs text-gray-500">Percentage of approvers required to approve</p>
            </div>

            <div id="specificField" class="space-y-2" style="display: none;">
                <label for="specific_approver_id" class="block text-sm font-medium text-gray-700">
                    üë§ Specific Approver
                </label>
                <select name="specific_approver_id" id="specific_approver_id"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                    <option value="">Select an approver</option>
                    {% for employee in employees %}
                    <option value="{{ employee.id }}">{{ employee.username }} ({{ employee.role|title }})</option>
                    {% endfor %}
                </select>
                <p class="text-xs text-gray-500">This person's approval will be sufficient</p>
            </div>

            <div class="space-y-2">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" name="is_manager_first" id="is_manager_first"
                        class="w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <label for="is_manager_first" class="text-sm font-medium text-gray-700">
                        üëî Require Manager Approval First
                    </label>
                </div>
                <p class="text-xs text-gray-500 ml-7">Employee's direct manager must approve before other approvers</p>
            </div>

            <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700">
                    üë• Sequential Approvers
                </label>
                <p class="text-xs text-gray-500">Add approvers who will review expenses in order</p>
                
                <div id="approversList" class="space-y-2">
                </div>
                
                <button type="button" id="addApprover"
                    class="w-full px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-purple-400 hover:text-purple-600 transition font-medium">
                    ‚ûï Add Approver
                </button>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="font-semibold text-blue-900 mb-2">üí° Rule Type Guide</h3>
                <ul class="text-sm text-blue-800 space-y-1">
                    <li><strong>Percentage:</strong> Requires X% of approvers to approve</li>
                    <li><strong>Specific:</strong> Only one specific person needs to approve</li>
                    <li><strong>Hybrid:</strong> Either the specific person OR the percentage threshold</li>
                    <li><strong>Sequential:</strong> All approvers must approve in order</li>
                </ul>
            </div>

            <div class="flex items-center space-x-4 pt-4">
                <button type="submit"
                    class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 px-6 rounded-lg hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200 font-semibold shadow-lg">
                    ‚úÖ Create Rule
                </button>
                <a href="{% url 'admin_dashboard' %}"
                    class="flex-1 bg-gray-200 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-300 transition duration-200 font-semibold text-center">
                    ‚ùå Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ruleType = document.getElementById('rule_type');
        const percentageField = document.getElementById('percentageField');
        const specificField = document.getElementById('specificField');
        const approversList = document.getElementById('approversList');
        const addApproverBtn = document.getElementById('addApprover');
        
        // ‚úÖ Proper JSON serialization using Django loop
        const employeesJson = [
            {% for employee in employees %}
            {id: {{ employee.id }}, username: "{{ employee.username }}", role: "{{ employee.role }}"}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        ruleType.addEventListener('change', function() {
            const value = this.value;
            
            percentageField.style.display = (value === 'percentage' || value === 'hybrid') ? 'block' : 'none';
            specificField.style.display = (value === 'specific' || value === 'hybrid') ? 'block' : 'none';
            
            if (value === 'percentage' || value === 'hybrid') {
                document.getElementById('percentage_threshold').required = true;
            } else {
                document.getElementById('percentage_threshold').required = false;
            }
        });
        
        addApproverBtn.addEventListener('click', function() {
            const index = approversList.children.length;
            const approverDiv = document.createElement('div');
            approverDiv.className = 'flex items-center space-x-2';
            approverDiv.innerHTML = `
                <span class="text-gray-500 font-medium">${index + 1}.</span>
                <select name="approvers[]" required
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                    <option value="">Select approver</option>
                    ${employeesJson.map(emp => 
                        `<option value="${emp.id}">${emp.username} (${emp.role.charAt(0).toUpperCase() + emp.role.slice(1)})</option>`
                    ).join('')}
                </select>
                <button type="button" onclick="this.parentElement.remove()" 
                    class="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition">
                    üóëÔ∏è
                </button>
            `;
            approversList.appendChild(approverDiv);
        });
    });
</script>
{% endblock %}
