{% extends 'base.html' %}
{% block title %}Manager Dashboard{% endblock %}
{% block content %}

<div class="min-h-screen bg-white text-gray-900 p-8 font-['Patrick_Hand',cursive]">

    <!-- Header -->
    <div class="flex items-center gap-3 mb-8">
        <div class="bg-green-200 text-green-900 px-3 py-1 rounded-full text-sm font-semibold shadow">
            Joyous Parrot
        </div>
        <h1 class="text-3xl font-bold tracking-wide">Managerâ€™s Dashboard</h1>
    </div>

    <!-- Debug Section (Temporary) -->
    <div class="mb-4 p-4 bg-gray-100 rounded-lg">
        <p>Debug: Number of visible expenses = {{ visible_expenses|length }}</p>
        {% if visible_expenses %}
            <p>Debug: First expense employee = {{ visible_expenses.0.employee.username|default:'No employee' }}</p>
        {% else %}
            <p>Debug: No expenses found in visible_expenses.</p>
        {% endif %}
    </div>

    <!-- Pending Approvals -->
    <div class="border-2 border-gray-300 rounded-3xl p-8 bg-white shadow-lg mb-10">
        <h2 class="text-2xl mb-6 font-semibold">Pending Approvals</h2>

        <div class="overflow-x-auto">
            <table class="min-w-full border border-gray-300 rounded-xl">
                <thead class="bg-gray-100">
                    <tr class="text-left border-b border-gray-300 text-gray-700">
                        <th class="py-3 px-4">Subject</th>
                        <th class="py-3 px-4">Employee</th>
                        <th class="py-3 px-4">Category</th>
                        <th class="py-3 px-4">Amount</th>
                        <th class="py-3 px-4">Currency</th>
                        <th class="py-3 px-4 text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for approval in pending_approvals %}
                    <tr class="border-b border-gray-200 hover:bg-gray-50 transition">
                        <td class="py-3 px-4">{{ approval.expense.description|truncatechars:25 }}</td>
                        <td class="py-3 px-4">{{ approval.expense.employee.username }}</td>
                        <td class="py-3 px-4">{{ approval.expense.get_category_display }}</td>
                        <td class="py-3 px-4">{{ approval.expense.amount }}</td>
                        <td class="py-3 px-4">{{ approval.expense.currency }}</td>
                        <td class="py-3 px-4 text-center">
                            <form method="post" action="{% url 'approve_expense' approval.expense.id %}" class="inline">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="approve">
                                <button type="submit"
                                    class="border-2 border-green-500 text-green-600 rounded-lg px-4 py-1 font-semibold hover:bg-green-500 hover:text-white transition">
                                    Approve
                                </button>
                            </form>
                            <form method="post" action="{% url 'approve_expense' approval.expense.id %}" class="inline">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="reject">
                                <button type="submit"
                                    class="border-2 border-red-500 text-red-600 rounded-lg px-4 py-1 font-semibold hover:bg-red-500 hover:text-white transition">
                                    Reject
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-10 text-gray-500 italic">
                            ðŸŽ‰ No pending approvals â€” everythingâ€™s up to date!
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- All Submitted Employee Expenses -->
    <div class="border-2 border-gray-300 rounded-3xl p-8 bg-white shadow-lg">
        <h2 class="text-2xl mb-6 font-semibold">All Submitted Employee Expenses</h2>

        <div class="overflow-x-auto">
            {% if visible_expenses %}
            <table class="min-w-full border border-gray-300 rounded-xl">
                <thead class="bg-gray-100">
                    <tr class="text-left border-b border-gray-300 text-gray-700">
                        <th class="py-3 px-4">Employee</th>
                        <th class="py-3 px-4">Description</th>
                        <th class="py-3 px-4">Category</th>
                        <th class="py-3 px-4">Amount</th>
                        <th class="py-3 px-4">Currency</th>
                        <th class="py-3 px-4">Status</th>
                        <th class="py-3 px-4">Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for exp in visible_expenses %}
                    <tr class="border-b border-gray-200 hover:bg-gray-50 transition">
                        <td class="py-3 px-4">{{ exp.employee.username }}</td>
                        <td class="py-3 px-4">{{ exp.description|truncatechars:25 }}</td>
                        <td class="py-3 px-4">{{ exp.get_category_display }}</td>
                        <td class="py-3 px-4">{{ exp.amount }}</td>
                        <td class="py-3 px-4">{{ exp.currency }}</td>
                        <td class="py-3 px-4">
                            {% if exp.status == 'approved' %}
                            <span class="text-green-600 font-semibold">Approved</span>
                            {% elif exp.status == 'rejected' %}
                            <span class="text-red-600 font-semibold">Rejected</span>
                            {% else %}
                            <span class="text-yellow-600 font-semibold">Pending</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4">{{ exp.expense_date }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-center py-10 text-gray-500 italic">
                No employee expenses submitted yet.
            </p>
            {% endif %}
        </div>
    </div>

    <!-- Footer Label -->
    <div class="flex justify-end mt-6">
        <div class="bg-amber-200 text-amber-900 px-3 py-1 rounded-full text-sm font-semibold shadow">
            Glorious Finch
        </div>
    </div>

</div>

<!-- Confirmation Popup -->
<script>
document.querySelectorAll("form").forEach(form => {
    form.addEventListener("submit", (e) => {
        const action = form.querySelector("input[name='action']").value;
        if (!confirm(`Are you sure you want to ${action} this expense?`)) {
            e.preventDefault();
        }
    });
});
</script>

{% endblock %}